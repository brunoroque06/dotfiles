#!/usr/bin/env bash

set -e

install() {
	./brew/setup

	SH=/opt/homebrew/bin/bash
	grep -qxF $SH /etc/shells || echo $SH | sudo tee -a /etc/shells
	chsh -s $SH

	grep -q homebrew "$HOME/.bash_profile" || echo "export PATH=/opt/homebrew/bin:$PATH" >"$HOME/.bash_profile"

	defaults write -g ApplePressAndHoldEnabled -bool true
}

paths=(
	elvish "$HOME/.config/elvish"
	git "$HOME"
	jetbrains "$HOME"
	neovim "$HOME/.config/nvim"
	nushell "$HOME/Library/Application Support/nushell"
	postgresql "$HOME"
	ripgrep "$HOME/.config"
	vivid "$HOME/.config/vivid"
	vscode "$HOME/Library/Application Support/Code/User"
	wezterm "$HOME/.config/wezterm"
)

link() {
	mkdir -p "$2"
	stow -S -v 1 -t "$2" "$1"
}

unlink() {
	stow -D -v 1 -t "$2" "$1"
}

for_config() {
	for ((i = 0; i < ${#paths[@]}; i += 2)); do
		$1 "${paths[i]}" "${paths[i + 1]}"
	done
}

case "$1" in
install)
	install
	;;
config)
	for_config link
	dotnet fsi tools/keybinds.fsx
	;;
unconfig)
	for_config unlink
	;;
*)
	printf 'Available Commands:\n'
	for o in $(grep -e '[a-z])' dotfiles | tr -d ')'); do printf '  %s\n' "$o"; done
	;;
esac
